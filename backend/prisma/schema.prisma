// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for authentication and authorization
model User {
  id            String    @id @default(cuid())
    indexNumber   String    @unique @map("index_number")
  email         String    @unique
  password      String
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  role          String    @default("STUDENT")
    department    String
  groupName     String?   @map("group_name")
  phone         String?
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLogin     DateTime? @map("last_login")

  // Relations
  bookings      Booking[]
  auditLogs     AuditLog[]
  refreshTokens RefreshToken[]

  @@map("users")
}

// enums removed: using string fields in models for compatibility

// Room model for classroom/venue management
model Room {
  id          String   @id @default(cuid())
  name        String   @unique
  capacity    Int
  building    String
  floor       String
  description String?
  equipment   String // Comma-separated equipment list
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  bookings  Booking[]
  timeSlots TimeSlot[]

  @@index([building])
  @@index([capacity])
  @@map("rooms")
}

// TimeSlot model for defining available booking periods
model TimeSlot {
  id        String   @id @default(cuid())
  roomId    String   @map("room_id")
  dayOfWeek Int      @map("day_of_week") // 0 = Sunday, 6 = Saturday
  startTime String   @map("start_time") // Format: "HH:mm"
  endTime   String   @map("end_time") // Format: "HH:mm"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Prevent duplicate time slots for the same room and day
  @@unique([roomId, dayOfWeek, startTime, endTime])
  @@index([roomId])
  @@index([dayOfWeek])
  @@map("time_slots")
}

// Booking model for room reservations
model Booking {
  id          String        @id @default(cuid())
  roomId      String        @map("room_id")
  userId      String        @map("user_id")
  title       String
  description String?
  date        String // ISO date string (YYYY-MM-DD)
  startTime   String        @map("start_time") // Format: "HH:mm"
  endTime     String        @map("end_time") // Format: "HH:mm"
  status      String        @default("PENDING")
  isRecurring Boolean       @default(false) @map("is_recurring")
  recurringId String?       @map("recurring_id") // Links recurring bookings
  notes       String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Prevent double booking - unique constraint on room, date, and time
  @@unique([roomId, date, startTime, endTime])
  @@index([roomId])
  @@index([userId])
  @@index([date])
  @@index([status])
  @@map("bookings")
}

// enums removed: using string fields in models for compatibility

// AuditLog model for tracking all system actions
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  String?  @map("old_values") // JSON string
  newValues  String?  @map("new_values") // JSON string
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// RefreshToken model for JWT refresh token management
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// Notification model for system notifications
model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      String
  title     String
  message   String
  isRead    Boolean          @default(false) @map("is_read")
  metadata  String? // JSON string
  createdAt DateTime         @default(now()) @map("created_at")

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// enums removed: using string fields in models for compatibility

// Department lookup table for available courses/programmes
model Department {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  @@map("departments")
}
